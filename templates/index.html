<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0078d7">
    <title>Interface de Escaneamento Facial</title>
    <style>
        /* Estilos CSS para o corpo da p√°gina */
        body {
            font-family: Arial, sans-serif; /* Fonte padr√£o */
            display: flex; /* Usa flexbox para alinhamento */
            flex-direction: column; /* Organiza os itens verticalmente */
            align-items: center; /* Centraliza os itens horizontalmente */
            padding: 20px;
            background-color: #071629; /* Cor de fundo escura, nova cor */
            color: #ecf0f1; /* Cor do texto para contraste */
            position: relative; /* Essencial para posicionar a logo */
            min-height: 100vh; /* Garante que o corpo ocupe a altura total da tela */
        }
        /* Estilos para o cont√™iner do v√≠deo */
        #video-container {
            position: relative;
            width: 640px;
            height: 480px;
            border: 2px solid #3498db; /* Borda azul para o cont√™iner */
            border-radius: 8px; /* Cantos arredondados */
            overflow: hidden; /* Oculta qualquer conte√∫do que transborde */
            background-color: #000;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); /* Sombra para dar profundidade */
        }
        /* Estilos para o elemento de v√≠deo */
        #video-stream {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Garante que o v√≠deo preencha todo o cont√™iner */
        }
        /* Estilos para o cont√™iner dos bot√µes */
        #controls {
            margin-top: 20px;
            display: flex;
            gap: 15px; /* Espa√ßamento entre os bot√µes */
        }
        /* Estilos para os bot√µes */
        button {
            padding: 12px 25px; /* Preenchimento interno */
            font-size: 17px; /* Tamanho da fonte */
            cursor: pointer; /* Muda o cursor para indicar que √© clic√°vel */
            border: none; /* Remove a borda padr√£o */
            border-radius: 5px; /* Cantos arredondados */
            background-color: #3498db; /* Cor de fundo azul */
            color: white; /* Cor do texto */
            transition: background-color 0.3s ease, transform 0.2s ease; /* Transi√ß√µes suaves para anima√ß√µes */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); /* Sombra para os bot√µes */
        }
        /* Efeito ao passar o mouse sobre o bot√£o */
        button:hover {
            background-color: #2980b9; /* Azul mais escuro */
            transform: translateY(-2px); /* Move o bot√£o 2px para cima */
        }
        /* Efeito ao clicar no bot√£o */
        button:active {
            transform: translateY(0); /* Retorna o bot√£o √† posi√ß√£o original */
        }
        /* Estilos para a mensagem de status */
        #status-message {
            margin-top: 20px;
            font-weight: bold; /* Deixa o texto em negrito */
            color: #ecf0f1; /* Cor do texto */
            font-size: 1.1em; /* Tamanho da fonte maior */
        }
        /* Estilos para o cont√™iner da logo */
        #logo-container {
            position: center; /* Posi√ß√£o absoluta em rela√ß√£o ao body */
            bottom: 40px; /* 20px da parte inferior */
            left: 40px; /* 20px da parte esquerda */
            width: 100px; /* Largura da logo */
            height: auto;
            opacity: 0.8; /* Transpar√™ncia inicial */
            transition: opacity 0.3s ease; /* Transi√ß√£o suave para a transpar√™ncia */
        }
        /* Efeito de passar o mouse na logo */
        #logo-container:hover {
            opacity: 1; /* Aumenta a opacidade para 100% */
        }
        /* Estilos para a imagem da logo */
        #logo-container img {
            max-width: 100%;
            height: auto;
            display: block;
        }
    </style>
</head>
<body>
    <h1>Registro de Presen√ßa</h1>

    <div id="video-container">
        <video id="video-stream" autoplay playsinline></video>
    </div>

    <div id="controls">
        <button id="capture-button">Fazer Chamada</button>
        <button id="register-button">Cadastrar Alunos</button>
        <button onclick="window.location.href='/admin'">Painel Admin</button>
    </div>

    <div id="status-message"></div>

    <canvas id="canvas" style="display:none;"></canvas>

    <div id="logo-container">
        <img src="static/votumaker.png">
    </div>

    <script>
        // Seleciona os elementos HTML e armazena em vari√°veis
        const videoStream = document.getElementById('video-stream');
        const captureButton = document.getElementById('capture-button');
        const registerButton = document.getElementById('register-button');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        const statusMessage = document.getElementById('status-message');

        // URL base do servidor backend - detecta automaticamente
        // Se rodando localmente, usa localhost:5000
        // Se precisar de ngrok, substitua por sua URL do ngrok
<<<<<<< HEAD
        const BACKEND_URL = "https://1eb458b7ff0f.ngrok-free.app"; // URL local
=======
        const BACKEND_URL = "http://localhost:5000"; // URL local
>>>>>>> c0a18bc647915de72619ff62510b96f22cb649a1

        // 1. Fun√ß√£o para iniciar a c√¢mera do usu√°rio
        async function startCamera() {
            try {
                // Solicita acesso √† c√¢mera (apenas v√≠deo)
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                // Atribui o stream de v√≠deo ao elemento <video>
                videoStream.srcObject = stream;
                // Exibe uma mensagem de sucesso
                statusMessage.textContent = 'C√¢mera iniciada. Olhe para a lente.';
            } catch (err) {
                // Em caso de erro, exibe uma mensagem de erro
                statusMessage.textContent = 'Erro ao acessar a c√¢mera. Verifique as permiss√µes.';
                console.error('Erro ao iniciar a c√¢mera:', err);
            }
        }

        // 2. Event listener para o bot√£o "Fazer Chamada"
        captureButton.addEventListener('click', async () => {
            // Verifica se a c√¢mera est√° ativa antes de continuar
            if (!videoStream.srcObject) {
                statusMessage.textContent = 'Erro: A c√¢mera n√£o est√° ativa.';
                return;
            }

            // Define as dimens√µes do canvas com base no v√≠deo
            canvas.width = videoStream.videoWidth;
            canvas.height = videoStream.videoHeight;
            // Desenha o frame atual do v√≠deo no canvas
            context.drawImage(videoStream, 0, 0, canvas.width, canvas.height);

            // Converte a imagem do canvas para uma string de dados (Data URL)
            const imageData = canvas.toDataURL('image/jpeg');

            statusMessage.textContent = 'Analisando imagem...';
            
            try {
                // Envia a imagem para o endpoint de chamada no backend
                const response = await fetch(`${BACKEND_URL}/chamada_webcam`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image_data: imageData
                    })
                });

                // Converte a resposta do servidor para JSON
                const result = await response.json();
                
                // Trata a resposta do servidor
                if (response.ok) {
                    if (result.status === 'presente') {
                        // Exibe a mensagem de sucesso com o nome e confian√ßa
                        statusMessage.textContent = `‚úÖ ${result.nome} Foi reconhecido! (Confian√ßa: ${result.confidence.toFixed(2)}%)`;
                        statusMessage.style.color = 'green';
                    } else if (result.status === 'presenca_removida') {
                        // Exibe mensagem quando presen√ßa foi removida
                        statusMessage.textContent = `üîÑ ${result.message}`;
                        statusMessage.style.color = 'orange';
                    } else if (result.status === 'turno_incorreto') {
                        // Exibe mensagem de turno incorreto mas registra mesmo assim
                        statusMessage.textContent = result.message;
                        statusMessage.style.color = 'orange';
                    } else if (result.status === 'ja_presente') {
                        // Exibe mensagem quando aluno j√° est√° presente
                        statusMessage.textContent = `‚ö†Ô∏è ${result.message}`;
                        statusMessage.style.color = 'orange';
                    } else {
                        // Exibe a mensagem de erro retornada pelo backend
                        statusMessage.textContent = `‚ùå ${result.message}`;
                        statusMessage.style.color = 'red';
                    }
                } else {
                    // Exibe o erro do servidor
                    statusMessage.textContent = `‚ùå Erro no servidor: ${result.message}`;
                    statusMessage.style.color = 'red';
                }

            } catch (error) {
                // Exibe uma mensagem de erro em caso de falha na conex√£o
                statusMessage.textContent = `‚ùå Erro de conex√£o: ${error.message}`;
                console.error('Erro no envio:', error);
            }
        });

        // 3. Event listener para o bot√£o "Cadastrar Alunos"
        registerButton.addEventListener('click', async () => {
            statusMessage.textContent = 'Iniciando cadastro dos alunos...';
            try {
                // Envia uma requisi√ß√£o GET para o endpoint de cadastro no backend
                const response = await fetch(`${BACKEND_URL}/cadastrar_alunos`);
                const result = await response.json();

                // Trata a resposta do servidor
                if (response.ok) {
                    statusMessage.textContent = `‚úÖ Cadastro conclu√≠do. Veja os logs no console do servidor.`;
                    console.log('Logs do cadastro:', result.log);
                } else {
                    statusMessage.textContent = `‚ùå Erro no cadastro: ${result.message}`;
                }

            } catch (error) {
                statusMessage.textContent = `‚ùå Erro de conex√£o com o backend: ${error.message}`;
                console.error('Erro no cadastro:', error);
            }
        });

        // Inicia a c√¢mera automaticamente quando a p√°gina √© carregada
        window.onload = startCamera;
    </script>
</body>
</html>